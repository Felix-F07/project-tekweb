<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Member Area</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .billing-card { background: linear-gradient(45deg, #1d976c, #93f9b9); color: white; }
    </style>
</head>
<body class="bg-light">
    <div id="navbar-container"></div>

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card billing-card shadow-sm">
                    <div class="card-body text-center">
                        <h5>Sisa Billing Anda</h5>
                        <h1 class="display-4 fw-bold" id="billingTime">00:00:00</h1>
                        <p id="usernameDisplay">User: Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <h4 class="mb-3">Beli Paket</h4>
        <div class="row" id="packageList">
            </div>
    </div>

    <div class="modal fade" id="paymentModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Pilih Metode Pembayaran</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p>Anda akan membeli: <strong id="selectedPackageName"></strong></p>
                    <p>Harga: <strong id="selectedPackagePrice"></strong></p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-pay" data-method="qris">Bayar QRIS</button>
                        <button class="btn btn-success btn-pay" data-method="cash">Bayar di Kasir</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUserId = localStorage.getItem('user_id');
        let selectedPackage = null;

        $(document).ready(function(){
                    $("#navbar-container").load("navbar.html");

                    loadPackages();
                    loadUserData();

            function loadPackages() {
                $.get('../../backend/api/packages.php', function(data){
                    let html = '';
                    data.forEach(pkg => {
                        html += `
                        <div class="col-md-4 col-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">${pkg.name}</h5>
                                    <h6 class="card-subtitle mb-2 text-muted">Rp ${parseInt(pkg.price).toLocaleString()}</h6>
                                    <p class="card-text">${pkg.description || 'Paket Warnet'}</p>
                                    <button class="btn btn-outline-primary w-100 btn-buy" 
                                        data-id="${pkg.id}" 
                                        data-name="${pkg.name}" 
                                        data-price="${pkg.price}"
                                        data-seconds="${pkg.seconds}">
                                        Beli
                                    </button>
                                </div>
                            </div>
                        </div>`;
                    });
                    $('#packageList').html(html);
                });
            }


            let billingSeconds = 0; 
            let billingTimer = null;
            let billingSyncTimer = null;
            const SYNC_INTERVAL = 15000; 

            function saveBillingToLocal() {
                if (currentUserId) {
                    localStorage.setItem('billing_seconds_' + currentUserId, billingSeconds);
                    localStorage.setItem('billing_timestamp_' + currentUserId, Date.now());
                    console.log('Saved to localStorage:', { billing_seconds: billingSeconds, timestamp: Date.now() });
                }
            }

            function getBillingFromLocal() {
                if (!currentUserId) return null;
                const savedSeconds = localStorage.getItem('billing_seconds_' + currentUserId);
                const savedTimestamp = localStorage.getItem('billing_timestamp_' + currentUserId);
                if (savedSeconds !== null && savedTimestamp !== null) {
                    const elapsedSeconds = Math.floor((Date.now() - parseInt(savedTimestamp)) / 1000);
                    const adjustedSeconds = Math.max(0, parseInt(savedSeconds) - elapsedSeconds);
                    console.log('Retrieved from localStorage:', { saved: savedSeconds, elapsed: elapsedSeconds, adjusted: adjustedSeconds });
                    return adjustedSeconds;
                }
                return null;
            }

            function syncBillingToServer() {
                if (!currentUserId) return;
                
                saveBillingToLocal();
                
                $.ajax({
                    url: '../../backend/api/billing_sync.php',
                    type: 'POST',
                    data: JSON.stringify({ 
                        user_id: currentUserId, 
                        billing_seconds: billingSeconds 
                    }),
                    contentType: 'application/json; charset=UTF-8',
                    dataType: 'json',
                    success: function(res) {
                        console.log('Billing synced to server:', res);
                    },
                    error: function(xhr, status, error) {
                        let errorMsg = 'Unknown error';
                        try {
                            const response = JSON.parse(xhr.responseText);
                            errorMsg = response.message || response.error || error;
                        } catch(e) {
                            errorMsg = xhr.statusText || error;
                        }
                        console.error('Failed to sync billing:', errorMsg, 'Status:', xhr.status);
                    }
                });
            }

            function startBillingTimer() {
                if (billingTimer) clearInterval(billingTimer);
                if (billingSyncTimer) clearInterval(billingSyncTimer);
                
                billingTimer = setInterval(() => {
                    if (billingSeconds > 0) {
                        billingSeconds -= 1;
                        $('#billingTime').text(secondsToHms(billingSeconds));
                        saveBillingToLocal();
                    }
                }, 1000);

                billingSyncTimer = setInterval(() => {
                    syncBillingToServer();
                }, SYNC_INTERVAL);
            }

            function fetchBillingFromServer(){
                $.get('../../backend/api/users.php', function(data){
                    let user = data.find(u => String(u.id) === String(currentUserId));
                    if(user) {
                        $('#usernameDisplay').text('User: ' + user.username);
                        const serverSec = parseInt(user.billing_seconds) || 0;
                        if (serverSec > billingSeconds) {
                            billingSeconds = serverSec;
                            $('#billingTime').text(secondsToHms(billingSeconds));
                            saveBillingToLocal();
                        }
                    }
                });
            }

            function loadUserData() {
                if (!currentUserId) {
                    console.error('User ID tidak ditemukan di localStorage');
                    $('#usernameDisplay').text('User: Belum Login');
                    return;
                }

                console.log('Loading user data for user ID:', currentUserId);
                
                const localBilling = getBillingFromLocal();
                console.log('Local billing from localStorage:', localBilling);

                $.get('../../backend/api/users.php', function(data){
                    console.log('Server response:', data);
                    let user = data.find(u => String(u.id) === String(currentUserId));
                    console.log('Found user:', user);
                    
                    if(user) {
                        $('#usernameDisplay').text('User: ' + user.username);
                        const serverSeconds = parseInt(user.billing_seconds) || 0;
                        
                        console.log('Server seconds:', serverSeconds, 'Local seconds:', localBilling);
                        
                        if (localBilling !== null) {
                            if (serverSeconds > localBilling) {
                                billingSeconds = serverSeconds;
                                console.log('Using server value (higher):', serverSeconds);
                            } else {
                                billingSeconds = localBilling;
                                console.log('Using local value:', localBilling);
                            }
                        } else {
                            billingSeconds = serverSeconds;
                            console.log('Using server value (no local):', serverSeconds);
                        }
                        
                        $('#billingTime').text(secondsToHms(billingSeconds));
                        saveBillingToLocal();
                        startBillingTimer();
                        syncBillingToServer();
                    } else {
                        console.error('User tidak ditemukan:', currentUserId);
                        $('#usernameDisplay').text('User: Tidak Ditemukan');
                        if (localBilling !== null) {
                            billingSeconds = localBilling;
                            $('#billingTime').text(secondsToHms(billingSeconds));
                            startBillingTimer();
                        }
                    }
                }).fail(function(xhr, status, error) {
                    console.error('Gagal load user data:', error, status, xhr);
                    $('#usernameDisplay').text('User: Error Loading');
                    if (localBilling !== null) {
                        billingSeconds = localBilling;
                        $('#billingTime').text(secondsToHms(billingSeconds));
                        startBillingTimer();
                    }
                });
            }

            $(document).on('click', '.btn-buy', function(){
                selectedPackage = $(this).data();
                $('#selectedPackageName').text(selectedPackage.name);
                $('#selectedPackagePrice').text('Rp ' + parseInt(selectedPackage.price).toLocaleString());
                $('#paymentModal').modal('show');
            });

            $('.btn-pay').click(function(){
                const method = $(this).data('method');
                
                const payload = {
                    user_id: currentUserId,
                    paket_id: selectedPackage.id,
                    price: selectedPackage.price,
                    seconds: selectedPackage.seconds
                };

                $.ajax({
                    url: '../../backend/api/packages.php?action=buy',
                    type: 'POST',
                    data: JSON.stringify(payload),
                    contentType: 'application/json; charset=UTF-8',
                    success: function(res){
                        alert(res.message);
                        $('#paymentModal').modal('hide');
                        billingSeconds = (billingSeconds || 0) + parseInt(selectedPackage.seconds || 0);
                        $('#billingTime').text(secondsToHms(billingSeconds));
                        saveBillingToLocal();
                        syncBillingToServer();
                    }
                });
            });

            function secondsToHms(d) {
                d = Number(d);
                var h = Math.floor(d / 3600);
                var m = Math.floor(d % 3600 / 60);
                var s = Math.floor(d % 3600 % 60);
                return ('0' + h).slice(-2) + ":" + ('0' + m).slice(-2) + ":" + ('0' + s).slice(-2);
            }

            window.addEventListener('beforeunload', function() {
                if (currentUserId) {
                    saveBillingToLocal();
                    if (navigator && navigator.sendBeacon) {
                        const payload = JSON.stringify({ 
                            user_id: currentUserId, 
                            billing_seconds: billingSeconds 
                        });
                        const blob = new Blob([payload], { type: 'application/json' });
                        navigator.sendBeacon('../../backend/api/billing_sync.php', blob);
                    }
                }
            });

            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'hidden') {
                    console.log('Tab hidden, syncing billing...');
                    saveBillingToLocal();
                    syncBillingToServer();
                }
            });
        });
    </script>
</body>
</html>