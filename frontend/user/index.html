<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Member Area</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .billing-card { background: linear-gradient(45deg, #1d976c, #93f9b9); color: white; }
    </style>
</head>
<body class="bg-light">
    <div id="navbar-container"></div>

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card billing-card shadow-sm">
                    <div class="card-body text-center">
                        <h5>Sisa Billing Anda</h5>
                        <h1 class="display-4 fw-bold" id="billingTime">00:00:00</h1>
                        <p id="usernameDisplay">User: Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <h4 class="mb-3">Beli Paket</h4>
        <div class="row" id="packageList">
            </div>
    </div>

    <div class="modal fade" id="paymentModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Pilih Metode Pembayaran</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p>Anda akan membeli: <strong id="selectedPackageName"></strong></p>
                    <p>Harga: <strong id="selectedPackagePrice"></strong></p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-pay" data-method="qris">Bayar QRIS</button>
                        <button class="btn btn-success btn-pay" data-method="cash">Bayar Kasir</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUserId = localStorage.getItem('user_id');
        let selectedPackage = null;

        $(document).ready(function(){
                    // load shared navbar
                    $("#navbar-container").load("navbar.html");

                    loadPackages();
                    loadUserData();

            // Load Data Paket
            function loadPackages() {
                $.get('../../backend/api/packages.php', function(data){
                    let html = '';
                    data.forEach(pkg => {
                        html += `
                        <div class="col-md-4 col-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">${pkg.name}</h5>
                                    <h6 class="card-subtitle mb-2 text-muted">Rp ${parseInt(pkg.price).toLocaleString()}</h6>
                                    <p class="card-text">${pkg.description || 'Paket Warnet'}</p>
                                    <button class="btn btn-outline-primary w-100 btn-buy" 
                                        data-id="${pkg.id}" 
                                        data-name="${pkg.name}" 
                                        data-price="${pkg.price}"
                                        data-seconds="${pkg.seconds}">
                                        Beli
                                    </button>
                                </div>
                            </div>
                        </div>`;
                    });
                    $('#packageList').html(html);
                });
            }

            // Ambil data user spesifik (untuk refresh billing)
            // Catatan: Idealnya buat endpoint khusus get_user_detail.php
            // Disini kita gunakan list users dan filter (kurang efisien tapi simple untuk demo)
            let billingSeconds = 0; // current countdown value in seconds
            let billingTimer = null;
            let syncInterval = 30000; // sync with server every 30s

            function startBillingTimer() {
                if (billingTimer) clearInterval(billingTimer);
                billingTimer = setInterval(() => {
                    if (billingSeconds > 0) {
                        billingSeconds -= 1;
                        $('#billingTime').text(secondsToHms(billingSeconds));
                    }
                }, 1000);
                // periodic sync to server to refresh value (in case of concurrent updates)
                setInterval(() => { fetchBillingFromServer(); }, syncInterval);
            }

            function fetchBillingFromServer(){
                $.get('../../backend/api/users.php', function(data){
                    let user = data.find(u => u.id == currentUserId);
                    if(user) {
                        $('#usernameDisplay').text('User: ' + user.username);
                        // Only override local countdown if server value differs by >5 seconds
                        const serverSec = parseInt(user.billing_seconds) || 0;
                        if (Math.abs(serverSec - billingSeconds) > 5) {
                            billingSeconds = serverSec;
                            $('#billingTime').text(secondsToHms(billingSeconds));
                        }
                    }
                });
            }

            function loadUserData() {
                $.get('../../backend/api/users.php', function(data){
                    let user = data.find(u => u.id == currentUserId);
                    if(user) {
                        $('#usernameDisplay').text('User: ' + user.username);
                        billingSeconds = parseInt(user.billing_seconds) || 0;
                        $('#billingTime').text(secondsToHms(billingSeconds));
                        startBillingTimer();
                    }
                });
            }

            // Klik Beli -> Buka Modal
            $(document).on('click', '.btn-buy', function(){
                selectedPackage = $(this).data();
                $('#selectedPackageName').text(selectedPackage.name);
                $('#selectedPackagePrice').text('Rp ' + parseInt(selectedPackage.price).toLocaleString());
                $('#paymentModal').modal('show');
            });

            // Proses Bayar
            $('.btn-pay').click(function(){
                const method = $(this).data('method');
                // Disini logika QRIS/Kasir bisa dibedakan. Untuk demo, anggap sukses semua.
                
                const payload = {
                    user_id: currentUserId,
                    paket_id: selectedPackage.id,
                    price: selectedPackage.price,
                    seconds: selectedPackage.seconds
                };

                $.ajax({
                    url: '../../backend/api/packages.php?action=buy',
                    type: 'POST',
                    data: JSON.stringify(payload),
                    success: function(res){
                        alert(res.message);
                        $('#paymentModal').modal('hide');
                            // Update local billingSeconds immediately (avoid waiting for sync)
                            billingSeconds = (billingSeconds || 0) + parseInt(selectedPackage.seconds || 0);
                            $('#billingTime').text(secondsToHms(billingSeconds));
                            // also fetch fresh from server shortly
                            setTimeout(fetchBillingFromServer, 1000);
                    }
                });
            });

            // Helper convert detik ke Jam:Menit:Detik
            function secondsToHms(d) {
                d = Number(d);
                var h = Math.floor(d / 3600);
                var m = Math.floor(d % 3600 / 60);
                var s = Math.floor(d % 3600 % 60);
                return ('0' + h).slice(-2) + ":" + ('0' + m).slice(-2) + ":" + ('0' + s).slice(-2);
            }
        });
    </script>
</body>
</html>