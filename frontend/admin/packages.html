<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Manajemen Paket</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div id="navbar-container"></div>

    <div class="container mt-4">
        <h2>Daftar Paket Billing</h2>
        <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addPkgModal">Tambah Paket Baru</button>
        <table class="table table-striped">
            <thead><tr><th>Nama</th><th>Harga</th><th>Durasi (Menit)</th><th>Deskripsi</th><th>Aksi</th></tr></thead>
            <tbody id="pkgTableBody"></tbody>
        </table>
    </div>

    <div class="modal fade" id="addPkgModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Tambah Paket</h5></div>
                <div class="modal-body">
                    <form id="formPkg">
                        <div class="mb-2"><input type="text" id="pName" class="form-control" placeholder="Nama Paket" required></div>
                        <div class="mb-2"><input type="number" id="pPrice" class="form-control" placeholder="Harga (Rp)" required></div>
                        <div class="mb-2"><input type="number" id="pSec" class="form-control" placeholder="Durasi (Menit)" required></div>
                        <div class="mb-2"><input type="text" id="pDesc" class="form-control" placeholder="Deskripsi"></div>
                        <button type="submit" class="btn btn-success w-100">Simpan</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function(){
            $("#navbar-container").load("navbar.html");
            loadPackages();

            function loadPackages() {
                $.get('../../backend/api/packages.php', function(data){
                    let rows = '';
                    data.forEach(p => {
                        let minutes = (parseInt(p.seconds) / 60);
                        let minutesLabel = Number.isInteger(minutes) ? minutes + ' menit' : minutes.toFixed(2) + ' menit';
                        rows += `<tr>
                            <td>${p.name}</td>
                            <td>Rp ${parseInt(p.price).toLocaleString()}</td>
                            <td>${minutesLabel}</td>
                            <td>${p.description}</td>
                            <td><button class="btn btn-danger btn-sm" onclick="softDeletePkg(${p.id})">Hapus</button></td>
                        </tr>`;
                    });
                    $('#pkgTableBody').html(rows);
                });
            }

            $('#formPkg').submit(function(e){
                e.preventDefault();
                const minutes = parseFloat($('#pSec').val());
                const seconds = Math.max(0, Math.round(minutes * 60));
                let data = {
                    name: $('#pName').val(),
                    price: $('#pPrice').val(),
                    seconds: seconds,
                    description: $('#pDesc').val()
                };
                $.ajax({
                    url: '../../backend/api/packages.php', type: 'POST',
                    data: JSON.stringify(data),
                    success: function(){
                        $('#addPkgModal').modal('hide');
                        loadPackages();
                    }
                });
            });

            window.softDeletePkg = function(id) {
                if(confirm('Hapus paket ini? (Tidak akan hilang dari history, hanya disembunyikan)')) {
                    $.ajax({
                        url: '../../backend/api/packages.php?id='+id,
                        type: 'DELETE',
                        success: function(){ loadPackages(); }
                    });
                }
            }
        });
    </script>
</body>
</html>